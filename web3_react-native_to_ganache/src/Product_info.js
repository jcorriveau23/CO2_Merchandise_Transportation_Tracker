import React, { Component } from 'react';
import { View, Text, Button, StyleSheet, Alert, Dimensions, ImageBackground, Linking } from 'react-native';
import { NavigationEvents, SafeAreaView } from "react-navigation";
import './shim';

const abi = [
	{
		"constant": false,
		"inputs": [
			{
				"internalType": "string",
				"name": "_upc",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_unique",
				"type": "uint256"
			}
		],
		"name": "Associate_Command",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_commandID",
				"type": "uint256"
			}
		],
		"name": "Associate_Traject",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"internalType": "string",
				"name": "_upc",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_weight",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_volume",
				"type": "uint256"
			}
		],
		"name": "New_product",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_trailerID",
				"type": "uint256"
			}
		],
		"name": "associate_trailer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"internalType": "string",
				"name": "ipfsHash",
				"type": "string"
			}
		],
		"name": "command_completed",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_commandID",
				"type": "uint256"
			}
		],
		"name": "get_command_info",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_commandID",
				"type": "uint256"
			},
			{
				"internalType": "uint8",
				"name": "_index",
				"type": "uint8"
			}
		],
		"name": "get_command_traject_list_index",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_commandID",
				"type": "uint256"
			}
		],
		"name": "get_command_traject_list_size",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "",
				"type": "uint8"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "get_current_command_id",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "get_current_trajectID",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "get_numUPC",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "nb",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "string",
				"name": "_upc",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_unique",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_index",
				"type": "uint256"
			}
		],
		"name": "get_product_commandID",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "string",
				"name": "_upc",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_unique",
				"type": "uint256"
			}
		],
		"name": "get_product_commands_size",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "string",
				"name": "_upc",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_trajectID",
				"type": "uint256"
			}
		],
		"name": "get_product_emission",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_trailerID",
				"type": "uint256"
			}
		],
		"name": "get_trailer_current_traject",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_trajectID",
				"type": "uint256"
			}
		],
		"name": "get_traject_emission",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_trajectID",
				"type": "uint256"
			}
		],
		"name": "get_traject_info",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "get_trucker_current_trajectID",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "string",
				"name": "_upc",
				"type": "string"
			}
		],
		"name": "get_upc_Volume",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "Volume",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "string",
				"name": "_upc",
				"type": "string"
			}
		],
		"name": "get_upc_weight",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "Weight",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_trajectID",
				"type": "uint256"
			}
		],
		"name": "grab_traject",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"internalType": "string",
				"name": "_IpfsTrajectHash",
				"type": "string"
			}
		],
		"name": "loading_completed",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "new_command",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "commandID",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "new_traject",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "trajectID",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_CO2Counter",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_truckID",
				"type": "uint256"
			}
		],
		"name": "traject_start",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_CO2Counter",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_truckID",
				"type": "uint256"
			}
		],
		"name": "traject_stop",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	}
];
const contract_address = '0xB9FFD1b6E5fdA101da064F52e5Ed1685be4f7aCD';

const Web3 = require('web3');
const IPFS = require('ipfs-mini');
const ipfs = new IPFS({ host: "ipfs.infura.io", port: 5001, protocol: "https" });

const Tx = require('ethereumjs-tx').Transaction;
import HDWalletProvider from 'truffle-hdwallet-provider';
const mnemonic = 'wagon sick artefact august more home program science famous fun magnet crew'; // 12 word mnemonic
const Provider = new HDWalletProvider(mnemonic, 'http://192.168.0.16:7545');
const web3 = new Web3(Provider);
const contract = new web3.eth.Contract(abi, contract_address);
const privateKey = '0x2f5a91464049996a4948ed874409f4cfc56c775ee89760bf9db212927668acb7'
const publicKey = '0xf9Bb59aF9eC60D64274a4d2a61D55CB004FBEa5e'

const Separator = () => (
	<View style={styles.separator} />
);

const Item = ({ commandID }) => (
	<View>
		<Text>{commandID}</Text>
	</View>
);

const renderItem = ({ item }) => (
	<Item commandID={item.commandID} />
);

export default class Info extends Component {
	constructor(props) {
		super(props);
		this.state = {
			UPC: "scan a product",
			Unique: 0,
			Json_Product_info: {
				commandIDList: [],
				productTotEmission: 0
			},
			trajectInfo: "",
			orderInfo: "",


		};
	}
	async going_back() {
		var ProductQrCode = await this.props.navigation.getParam("data", "No data read");
		if (ProductQrCode != "No data read") {
			this.setState({ UPC: ProductQrCode.UPC });
			this.setState({ Unique: ProductQrCode.Unique });

			var size = this.Get_product_info(this.state.UPC, this.state.Unique);
		}
	}
	async Get_product_info(UPC, unique) {
		var lenght = 0;
		var commandLenght;
		var trajectLenght;
		var commandID;
		var trajectID;
		var totProductEmission = 0;
		var ProductCO2EmissionPart = 0;
		var trajectCO2Emission = 0;


		var JsonProductInfo = {
			"commandIDList": []
		}

		try {
			commandLenght = await contract.methods.get_product_commands_size(UPC, unique).call();
			console.log(lenght);
		}
		catch (e) {
			Alert.alert('Product not registered yet', 'Product UPC: ' + UPC + '\nUnique ID: ' + unique);
		}


		var i = 0;
		for (i = 0; i < commandLenght; i++) {

			commandID = await contract.methods.get_product_commandID(UPC, unique, i).call();
			await this.get_command_info(commandID);

			var newCommandID = {
				"commandID": commandID,
				"commandHash": this.state.orderInfo['3'],
				"trajectList": []
			};

			try {
				trajectLenght = await contract.methods.get_command_traject_list_size(commandID).call();
				var j = 0;
				for (j = 0; j < trajectLenght; j++) {
					trajectID = await contract.methods.get_command_traject_list_index(commandID, j).call();

					await this.get_traject_info(trajectID);
					ProductCO2EmissionPart = await contract.methods.get_product_emission(UPC, trajectID).call();

					totProductEmission = parseInt(totProductEmission) + parseInt(ProductCO2EmissionPart);

					var newTrajectID = {
						"trajectID": trajectID,
						"trajectHash": this.state.trajectInfo['6'],
						"trajectCO2Emission": this.state.trajectInfo['2'],
						"ProductCO2EmissionPart": ProductCO2EmissionPart
					};

					newCommandID["trajectList"].push(newTrajectID)
				}
			}
			catch (e) {
				console.log(e);
				console.log("some command are not yet assigned to a traject")
			}
			JsonProductInfo["commandIDList"].push(newCommandID);
			JsonProductInfo["productTotEmission"] = totProductEmission;
		}
		console.log(JsonProductInfo);
		this.setState({ Json_Product_info: JsonProductInfo })
		return commandLenght;
	}
	async get_traject_info(trajectID) {
		try {
			var trajectInfo = await contract.methods.get_traject_info(trajectID).call();
			this.setState({ trajectInfo: trajectInfo });
			return trajectInfo;
		}
		catch (e) {
			Alert.alert('Error: this command ID does not exist', 'Traject ID: ' + trajectID);
		}
	}
	async get_command_info(commandID) {
		try {
			var orderInfo = await contract.methods.get_command_info(commandID).call();
			this.setState({ orderInfo: orderInfo });
			return orderInfo;
		}
		catch (e) {
			Alert.alert('Error: this command ID does not exist', 'Traject ID: ' + commandID);
		}
	}
	render() {
		return (
			<SafeAreaView style={styles.container}>
				<NavigationEvents onDidFocus={() => this.going_back()} />
				<View style={styles.header}>
					<ImageBackground
						source={require("../asset/header.png")}
						style={styles.imageBackground}
						resizeMode="contain"
					>
						<Text style={styles.title}>Product Info</Text>
					</ImageBackground>
				</View>
				<View>
					<Button
						color={'green'}
						title={"Scan a product"}
						onPress={() => this.props.navigation.navigate("QRCodeScannerScreen", {
							data: "get_product_info"
						})}
					/>
				</View>
				<Text style={styles.text}>Scan a product, and it will tells you his order, traject and CO2 emissions transportation's part</Text>
				<Separator />
				<View>
					<Text style={styles.textBold}>UPC: {this.state.UPC}</Text>
					<Text style={styles.textBold}>Unique: {this.state.Unique}</Text>
					{this.state.Json_Product_info.commandIDList.map((command, index) => {
						return <View>
							<Text style={styles.textBold}>command ID: {command.commandID}</Text>
							<Text style={styles.ipfs}
								onPress={() => Linking.openURL("https://ipfs.infura.io/ipfs/" + command.commandHash)}
							>IPFS order hash: {String(command.commandHash)}
							</Text>
							{
								command.trajectList.map((traject, index) => {
									return <>
										<Text style={styles.textBold}>  traject ID: {traject.trajectID} </Text>
										<Text style={styles.ipfs}
											onPress={() => Linking.openURL("https://ipfs.infura.io/ipfs/" + traject.trajectHash)}
										>IPFS traject hash: {String(traject.trajectHash)}
										</Text>
										<Text style={styles.text}>      traject's total': {traject.trajectCO2Emission} kg CO2 éq.</Text>
										<Text>      product's part: {traject.ProductCO2EmissionPart} kg CO2 éq.</Text>
									</>
								}
								)
							}
						</View>
					})}
					<Text style={styles.textBold}>Product total transport emissions: {this.state.Json_Product_info['productTotEmission']}  kg CO2 éq.</Text>
				</View>
			</SafeAreaView>
		);
	}
}

const width = Dimensions.get("screen").width;

const styles = StyleSheet.create({
	container: {
		flex: 1,
		backgroundColor: "white"
	},
	header: {
		marginTop: 0
	},
	text: {
		fontSize: 14,
		textAlign: "justify",
		margin: 0
	},
	textBold: {
		fontSize: 14,
		textAlign: "justify",
		margin: 0,
		fontWeight: "bold"
	},
	ipfs: {
		fontSize: 9,
		textAlign: "center",
		color: 'blue',
		fontWeight: "bold"
	},
	imageBackground: {
		width: width * 0.4,
		height: width * 0.4,
		alignItems: 'center'
	},
	title: {
		color: 'white',
		marginTop: 25,
		fontWeight: 'bold',
		fontSize: 15
	},
	separator: {
		marginVertical: 8,
		borderBottomColor: '#737373',
		borderBottomWidth: StyleSheet.hairlineWidth,
	}
});